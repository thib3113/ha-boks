name: Release Boks Integration

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write
  attestations: write
  artifact-metadata: write

jobs:
  test:
    uses: ./.github/workflows/tests.yaml

  build:
    name: Build Integration Bundle
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Create ZIP archive
        run: |
          cd custom_components/boks
          zip -r "../../boks.zip" .

      - name: Verify ZIP structure
        run: |
          if ! unzip -l boks.zip | grep -q " manifest.json$"; then
            echo "Error: manifest.json not found at the root of the ZIP archive."
            exit 1
          fi

      - name: Generate Checksums
        run: shasum -a 256 boks.zip > checksums.txt

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: boks-bundle
          path: |
            boks.zip
            checksums.txt
          retention-days: 1

  publish:
    name: Attest and Publish Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: boks-bundle

      - name: Attest Build Provenance
        id: attest
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3 # Upgraded to v3
        with:
          subject-checksums: checksums.txt # Attesting via checksums file

      - name: Create and Populate Release
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        env:
          TAG_NAME: ${{ github.ref_name }}
          # Use the official output URL from the attest action
          ATTESTATION_URL: ${{ steps.attest.outputs.attestation-url }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          RUN_ID: ${{ github.run_id }}
          SERVER_URL: ${{ github.server_url }}
        with:
          script: |
            const fs = require('fs');
            const { 
              TAG_NAME, ATTESTATION_URL, REPO_OWNER, 
              REPO_NAME, RUN_ID, SERVER_URL 
            } = process.env;

            // 1. Create the final Release
            const release = await github.rest.repos.createRelease({
              owner: REPO_OWNER,
              repo: REPO_NAME,
              tag_name: TAG_NAME,
              name: `Release ${TAG_NAME}`,
              prerelease: true,
              make_latest: 'false',
              generate_release_notes: true
            });

            // 2. Upload both ZIP and Checksums
            const filesToUpload = ['boks.zip', 'checksums.txt'];
            for (const fileName of filesToUpload) {
              await github.rest.repos.uploadReleaseAsset({
                owner: REPO_OWNER,
                repo: REPO_NAME,
                release_id: release.data.id,
                name: fileName,
                data: fs.readFileSync(fileName),
                headers: {
                  'content-type': fileName.endsWith('.zip') ? 'application/zip' : 'text/plain',
                  'content-length': fs.statSync(fileName).size
                }
              });
            }

            // 3. Update body with the official attestation link
            const footer = `
            ---
            ### üõ°Ô∏è Security & Provenance
            This release includes signed build provenance attestations.
            - **Official Attestation**: [Verify on GitHub](${ATTESTATION_URL})
            - **Manual Verification**:
              \`\`\`bash
              # Verify the zip using the checksums file
              shasum -a 256 -c checksums.txt
              # Verify the attestation via GitHub CLI
              gh attestation verify boks.zip --repo ${REPO_OWNER}/${REPO_NAME}
              \`\`\`
            **Workflow Run**: [Execution #${RUN_ID}](${SERVER_URL}/${REPO_OWNER}/${REPO_NAME}/actions/runs/${RUN_ID})`;

            await github.rest.repos.updateRelease({
              owner: REPO_OWNER,
              repo: REPO_NAME,
              release_id: release.data.id,
              body: (release.data.body || '') + footer
            });